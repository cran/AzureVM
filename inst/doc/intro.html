<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Hong Ooi" />


<title>Introduction to AzureVM</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">Introduction to AzureVM</h1>
<h4 class="author"><em>Hong Ooi</em></h4>



<p>AzureVM is a package for interacting with virtual machines and virtual machine scalesets in Azure. You can deploy, start up, shut down, run scripts, deallocate and delete VMs and scalesets from the R command line. It uses the tools provided by the <a href="https://github.com/Azure/AzureRMR">AzureRMR package</a> to manage VM resources and templates.</p>
<div id="virtual-machines" class="section level2">
<h2>Virtual machines</h2>
<p>Here is a simple example. We create a VM using the default settings, run a shell command, resize the VM, and then delete it.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">library</span>(AzureVM)</a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3">sub &lt;-<span class="st"> </span>AzureRMR<span class="op">::</span><span class="kw">get_azure_login</span>()<span class="op">$</span></a>
<a class="sourceLine" id="cb1-4" title="4"><span class="st">    </span><span class="kw">get_subscription</span>(<span class="st">&quot;sub_id&quot;</span>)</a>
<a class="sourceLine" id="cb1-5" title="5"></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co"># calling create_vm() from a subscription object will create the VM in its own resource group</span></a>
<a class="sourceLine" id="cb1-7" title="7"><span class="co"># default is an Ubuntu 18.04 VM, size Standard_DS3_v2, login via SSH key</span></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co"># call sub$list_vm_sizes() to get the sizes available in your region</span></a>
<a class="sourceLine" id="cb1-9" title="9">vm &lt;-<span class="st"> </span>sub<span class="op">$</span><span class="kw">create_vm</span>(<span class="st">&quot;myubuntuvm&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="st">&quot;~/.ssh/id_rsa.pub&quot;</span>),</a>
<a class="sourceLine" id="cb1-10" title="10">                    <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>)</a>
<a class="sourceLine" id="cb1-11" title="11"></a>
<a class="sourceLine" id="cb1-12" title="12"><span class="co"># some resources used by the VM</span></a>
<a class="sourceLine" id="cb1-13" title="13">vm<span class="op">$</span><span class="kw">get_vnet</span>()</a>
<a class="sourceLine" id="cb1-14" title="14">vm<span class="op">$</span><span class="kw">get_public_ip_resource</span>()</a>
<a class="sourceLine" id="cb1-15" title="15">vm<span class="op">$</span><span class="kw">get_disk</span>(<span class="st">&quot;os&quot;</span>)</a>
<a class="sourceLine" id="cb1-16" title="16"></a>
<a class="sourceLine" id="cb1-17" title="17"><span class="co"># run a shell script or command remotely (will be PowerShell on a Windows VM)</span></a>
<a class="sourceLine" id="cb1-18" title="18">vm<span class="op">$</span><span class="kw">run_script</span>(<span class="st">&quot;echo hello world! &gt; /tmp/hello.txt&quot;</span>)</a>
<a class="sourceLine" id="cb1-19" title="19"></a>
<a class="sourceLine" id="cb1-20" title="20"><span class="co"># ... and stop it</span></a>
<a class="sourceLine" id="cb1-21" title="21">vm<span class="op">$</span><span class="kw">stop</span>()</a>
<a class="sourceLine" id="cb1-22" title="22"></a>
<a class="sourceLine" id="cb1-23" title="23"><span class="co"># ... and resize it</span></a>
<a class="sourceLine" id="cb1-24" title="24">vm<span class="op">$</span><span class="kw">resize</span>(<span class="st">&quot;Standard_DS4_v2&quot;</span>)</a>
<a class="sourceLine" id="cb1-25" title="25"></a>
<a class="sourceLine" id="cb1-26" title="26"><span class="co"># ... and delete it (this can be done asynchronously for a VM in its own group)</span></a>
<a class="sourceLine" id="cb1-27" title="27">vm<span class="op">$</span><span class="kw">delete</span>()</a></code></pre></div>
<p>AzureVM comes with a number of predefined configurations, for deploying commonly used VM images. For example, to create an Ubuntu DSVM accessible via SSH, JupyterHub and RStudio Server:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1">sub<span class="op">$</span><span class="kw">create_vm</span>(<span class="st">&quot;mydsvm&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="st">&quot;~/.ssh/id_rsa.pub&quot;</span>), <span class="dt">config=</span><span class="st">&quot;ubuntu_dsvm&quot;</span>,</a>
<a class="sourceLine" id="cb2-2" title="2">              <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>)</a></code></pre></div>
<p>And to create a Windows Server 2019 VM, accessible via RDP:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1">sub<span class="op">$</span><span class="kw">create_vm</span>(<span class="st">&quot;mywinvm&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="dt">password=</span><span class="st">&quot;Use-strong-passwords!&quot;</span>), <span class="dt">config=</span><span class="st">&quot;windows_2019&quot;</span>,</a>
<a class="sourceLine" id="cb3-2" title="2">              <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>)</a></code></pre></div>
<p>The available predefined configurations are <code>ubuntu_18.04</code> (the default), <code>ubuntu_16.04</code>, <code>ubuntu_dsvm</code>, <code>windows_2019</code>, <code>windows_2016</code>, <code>windows_dsvm</code>, <code>rhel_7.6</code>, <code>rhel_8</code>, <code>centos_7.5</code>, <code>centos_7.6</code>, <code>debian_8_backports</code> and <code>debian_9_backports</code>. You can combine these with several other arguments to customise the VM deployment to your needs:</p>
<ul>
<li><code>size</code>: VM size. Use the <code>list_vm_sizes</code> method for the subscription and resource group classes to see the available sizes.</li>
<li><code>datadisks</code>: The data disk sizes/configurations to attach.</li>
<li><code>ip</code>: Public IP address. Set this to NULL if you don’t want the VM to be accessible outside its subnet.</li>
<li><code>vnet</code>: Virtual network/subnet.</li>
<li><code>nsg</code>: Network security group. AzureVM will associate the NSG with the vnet/subnet, not with the VM’s network interface.</li>
<li><code>nic</code>: Network interface.</li>
<li><code>other_resources</code>: Optionally, a list of other resources to deploy.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="co"># Windows Server 2016, with a 500GB datadisk attached, not publicly accessible</span></a>
<a class="sourceLine" id="cb4-2" title="2">sub<span class="op">$</span><span class="kw">create_vm</span>(<span class="st">&quot;mywinvm2&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="dt">password=</span><span class="st">&quot;Use-strong-passwords!&quot;</span>),</a>
<a class="sourceLine" id="cb4-3" title="3">              <span class="dt">size=</span><span class="st">&quot;Standard_DS4_v2&quot;</span>, <span class="dt">config=</span><span class="st">&quot;windows_2016&quot;</span>, <span class="dt">datadisks=</span><span class="dv">500</span>, <span class="dt">ip=</span><span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb4-4" title="4">              <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>)</a>
<a class="sourceLine" id="cb4-5" title="5"></a>
<a class="sourceLine" id="cb4-6" title="6"><span class="co"># Ubuntu DSVM, GPU-enabled</span></a>
<a class="sourceLine" id="cb4-7" title="7">sub<span class="op">$</span><span class="kw">create_vm</span>(<span class="st">&quot;mydsvm&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="st">&quot;~/.ssh/id_rsa.pub&quot;</span>), <span class="dt">size=</span><span class="st">&quot;Standard_NC12&quot;</span>,</a>
<a class="sourceLine" id="cb4-8" title="8">              <span class="dt">config=</span><span class="st">&quot;ubuntu_dsvm_ss&quot;</span>,</a>
<a class="sourceLine" id="cb4-9" title="9">              <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>)</a>
<a class="sourceLine" id="cb4-10" title="10"></a>
<a class="sourceLine" id="cb4-11" title="11"><span class="co"># Red Hat VM, serving HTTP/HTTPS</span></a>
<a class="sourceLine" id="cb4-12" title="12">sub<span class="op">$</span><span class="kw">create_vm</span>(<span class="st">&quot;myrhvm&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="st">&quot;~/.ssh/id_rsa.pub&quot;</span>), <span class="dt">config=</span><span class="st">&quot;rhel_8&quot;</span>,</a>
<a class="sourceLine" id="cb4-13" title="13">              <span class="dt">nsg=</span><span class="kw">nsg_config</span>(<span class="kw">list</span>(nsg_rule_allow_http, nsg_rule_allow_https)),</a>
<a class="sourceLine" id="cb4-14" title="14">              <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>)</a></code></pre></div>
<p>Full customisation is provided by the <code>vm_config</code> function, which also lets you specify the image to deploy, either from the marketplace or a disk. (The predefined configurations actually call <code>vm_config</code>, with the appropriate arguments for each specific config.)</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co">## custom VM configuration: Windows 10 Pro 1903 with data disks</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="co">## this assumes you have a valid Win10 desktop license</span></a>
<a class="sourceLine" id="cb5-3" title="3">user &lt;-<span class="st"> </span><span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="dt">password=</span><span class="st">&quot;Use-strong-passwords!&quot;</span>)</a>
<a class="sourceLine" id="cb5-4" title="4">image &lt;-<span class="st"> </span><span class="kw">image_config</span>(</a>
<a class="sourceLine" id="cb5-5" title="5">     <span class="dt">publisher=</span><span class="st">&quot;MicrosoftWindowsDesktop&quot;</span>,</a>
<a class="sourceLine" id="cb5-6" title="6">     <span class="dt">offer=</span><span class="st">&quot;Windows-10&quot;</span>,</a>
<a class="sourceLine" id="cb5-7" title="7">     <span class="dt">sku=</span><span class="st">&quot;19h1-pro&quot;</span></a>
<a class="sourceLine" id="cb5-8" title="8">)</a>
<a class="sourceLine" id="cb5-9" title="9">datadisks &lt;-<span class="st"> </span><span class="kw">list</span>(</a>
<a class="sourceLine" id="cb5-10" title="10">    <span class="kw">datadisk_config</span>(<span class="dv">250</span>, <span class="dt">type=</span><span class="st">&quot;Premium_LRS&quot;</span>),</a>
<a class="sourceLine" id="cb5-11" title="11">    <span class="kw">datadisk_config</span>(<span class="dv">1000</span>, <span class="dt">type=</span><span class="st">&quot;Standard_LRS&quot;</span>)</a>
<a class="sourceLine" id="cb5-12" title="12">)</a>
<a class="sourceLine" id="cb5-13" title="13">nsg &lt;-<span class="st"> </span><span class="kw">nsg_config</span>(</a>
<a class="sourceLine" id="cb5-14" title="14">    <span class="kw">list</span>(nsg_rule_allow_rdp)</a>
<a class="sourceLine" id="cb5-15" title="15">)</a>
<a class="sourceLine" id="cb5-16" title="16">sub<span class="op">$</span><span class="kw">create_vm</span>(<span class="st">&quot;mywin10vm&quot;</span>, user,</a>
<a class="sourceLine" id="cb5-17" title="17">    <span class="dt">config=</span><span class="kw">vm_config</span>(</a>
<a class="sourceLine" id="cb5-18" title="18">        <span class="dt">image=</span>image,</a>
<a class="sourceLine" id="cb5-19" title="19">        <span class="dt">keylogin=</span><span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb5-20" title="20">        <span class="dt">datadisks=</span>datadisks,</a>
<a class="sourceLine" id="cb5-21" title="21">        <span class="dt">nsg=</span>nsg,</a>
<a class="sourceLine" id="cb5-22" title="22">        <span class="dt">properties=</span><span class="kw">list</span>(<span class="dt">licenseType=</span><span class="st">&quot;Windows_Client&quot;</span>)</a>
<a class="sourceLine" id="cb5-23" title="23">    ),</a>
<a class="sourceLine" id="cb5-24" title="24">    <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span></a>
<a class="sourceLine" id="cb5-25" title="25">)</a></code></pre></div>
</div>
<div id="vm-scalesets" class="section level2">
<h2>VM scalesets</h2>
<p>The equivalent to <code>create_vm</code> for scalesets is the <code>create_vm_scaleset</code> method. By default, a new scaleset will come with a load balancer and autoscaler attached, but its instances will not be externally accessible.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co"># default is Ubuntu 18.04 scaleset, size Standard_DS1_v2</span></a>
<a class="sourceLine" id="cb6-2" title="2">sub<span class="op">$</span><span class="kw">create_vm_scaleset</span>(<span class="st">&quot;myubuntuss&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="st">&quot;~/.ssh/id_rsa.pub&quot;</span>), <span class="dt">instances=</span><span class="dv">5</span>,</a>
<a class="sourceLine" id="cb6-3" title="3">                       <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>)</a></code></pre></div>
<p>Each predefined VM configuration has a corresponding scaleset configuration. To specify low-level scaleset options, use the <code>scaleset_options</code> function. Here are some sample scaleset deployments:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="co"># Windows Server 2019</span></a>
<a class="sourceLine" id="cb7-2" title="2">sub<span class="op">$</span><span class="kw">create_vm_scaleset</span>(<span class="st">&quot;mywinss&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="dt">password=</span><span class="st">&quot;Use-strong-passwords!&quot;</span>), <span class="dt">instances=</span><span class="dv">5</span>,</a>
<a class="sourceLine" id="cb7-3" title="3">                       <span class="dt">config=</span><span class="st">&quot;windows_2019&quot;</span>,</a>
<a class="sourceLine" id="cb7-4" title="4">                       <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>)</a>
<a class="sourceLine" id="cb7-5" title="5"></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="co"># RHEL scaleset, serving HTTP/HTTPS</span></a>
<a class="sourceLine" id="cb7-7" title="7">sub<span class="op">$</span><span class="kw">create_vm_scaleset</span>(<span class="st">&quot;myrhelss&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="st">&quot;~/.ssh/id_rsa.pub&quot;</span>), <span class="dt">instances=</span><span class="dv">5</span>,</a>
<a class="sourceLine" id="cb7-8" title="8">                        <span class="dt">config=</span><span class="st">&quot;rhel_8_ss&quot;</span>,</a>
<a class="sourceLine" id="cb7-9" title="9">                        <span class="dt">nsg=</span><span class="kw">nsg_config</span>(<span class="kw">list</span>(nsg_rule_allow_http, nsg_rule_allow_https)),</a>
<a class="sourceLine" id="cb7-10" title="10">                        <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>)</a>
<a class="sourceLine" id="cb7-11" title="11"></a>
<a class="sourceLine" id="cb7-12" title="12"><span class="co"># Ubuntu DSVM, GPU-enabled, public instances, no load balancer or autoscaler</span></a>
<a class="sourceLine" id="cb7-13" title="13">sub<span class="op">$</span><span class="kw">create_vm_scaleset</span>(<span class="st">&quot;mydsvmss&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="st">&quot;~/.ssh/id_rsa.pub&quot;</span>), <span class="dt">instances=</span><span class="dv">5</span>,</a>
<a class="sourceLine" id="cb7-14" title="14">                       <span class="dt">size=</span><span class="st">&quot;Standard_NC6&quot;</span>, <span class="dt">config=</span><span class="st">&quot;ubuntu_dsvm_ss&quot;</span>,</a>
<a class="sourceLine" id="cb7-15" title="15">                       <span class="dt">options=</span><span class="kw">scaleset_options</span>(<span class="dt">public=</span><span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb7-16" title="16">                       <span class="dt">load_balancer=</span><span class="ot">NULL</span>, <span class="dt">autoscaler=</span><span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb7-17" title="17">                       <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>)</a>
<a class="sourceLine" id="cb7-18" title="18"></a>
<a class="sourceLine" id="cb7-19" title="19"><span class="co"># Large Debian scaleset (multiple placement groups), using low-priority VMs</span></a>
<a class="sourceLine" id="cb7-20" title="20"><span class="co"># need to set the instance size to something that supports low-pri</span></a>
<a class="sourceLine" id="cb7-21" title="21">sub<span class="op">$</span><span class="kw">create_vm_scaleset</span>(<span class="st">&quot;mylargess&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="st">&quot;~/.ssh/id_rsa.pub&quot;</span>), <span class="dt">instances=</span><span class="dv">10</span>,</a>
<a class="sourceLine" id="cb7-22" title="22">                       <span class="dt">size=</span><span class="st">&quot;Standard_DS3_v2&quot;</span>, <span class="dt">config=</span><span class="st">&quot;debian_9_backports_ss&quot;</span>,</a>
<a class="sourceLine" id="cb7-23" title="23">                       <span class="dt">options=</span><span class="kw">scaleset_options</span>(<span class="dt">low_priority=</span><span class="ot">TRUE</span>, <span class="dt">large_scaleset=</span><span class="ot">TRUE</span>),</a>
<a class="sourceLine" id="cb7-24" title="24">                       <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>)</a></code></pre></div>
<p>Working with scaleset instances can be tedious if you have a large scaleset, since R can only connect to one instance at a time. To solve this problem, AzureVM creates a pool of background processes that connect in parallel with the scaleset, leading to significant speedups. The pool is created automatically the first time it is needed, and is deleted at the end of the session.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="co"># this will create a pool of up to 10 processes that talk to the scaleset</span></a>
<a class="sourceLine" id="cb8-2" title="2">mylargess<span class="op">$</span><span class="kw">run_script</span>(<span class="st">&quot;echo hello world! &gt; /tmp/hello.txt&quot;</span>)</a></code></pre></div>
<p>You can control the size of the pool with the global <code>azure_vm_minpoolsize</code> and <code>azure_vm_maxpoolsize</code> options, which have default values 2 and 10 respectively. To turn off parallel connections, set <code>options(azure_vm_maxpoolsize=0)</code>. Note that the pool size is unrelated to the <em>scaleset</em> size; it only controls how many instances can communicate with AzureVM simultaneously.</p>
</div>
<div id="sharing-resources" class="section level2">
<h2>Sharing resources</h2>
<p>You can also include an existing Azure resource in a deployment, by supplying an AzureRMR <code>az_resource</code> object as an argument in the <code>create_vm</code> or <code>create_vm_scaleset</code> call. For example, here we create a VM and a scaleset that share a single virtual network/subnet.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="co">## VM and scaleset in the same resource group and virtual network</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co"># first, create the resgroup</span></a>
<a class="sourceLine" id="cb9-3" title="3">rg &lt;-<span class="st"> </span>sub<span class="op">$</span><span class="kw">create_resource_group</span>(<span class="st">&quot;rgname&quot;</span>, <span class="st">&quot;australiaeast&quot;</span>)</a>
<a class="sourceLine" id="cb9-4" title="4"></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co"># create the master</span></a>
<a class="sourceLine" id="cb9-6" title="6">rg<span class="op">$</span><span class="kw">create_vm</span>(<span class="st">&quot;mastervm&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="st">&quot;~/.ssh/id_rsa.pub&quot;</span>))</a>
<a class="sourceLine" id="cb9-7" title="7"></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="co"># get the vnet resource</span></a>
<a class="sourceLine" id="cb9-9" title="9">vnet &lt;-<span class="st"> </span>rg<span class="op">$</span><span class="kw">get_resource</span>(<span class="dt">type=</span><span class="st">&quot;Microsoft.Network/virtualNetworks&quot;</span>, <span class="dt">name=</span><span class="st">&quot;mastervm-vnet&quot;</span>)</a>
<a class="sourceLine" id="cb9-10" title="10"></a>
<a class="sourceLine" id="cb9-11" title="11"><span class="co"># create the scaleset</span></a>
<a class="sourceLine" id="cb9-12" title="12"><span class="co"># since the NSG is associated with the vnet, we don&#39;t need to create a new NSG either</span></a>
<a class="sourceLine" id="cb9-13" title="13">rg<span class="op">$</span><span class="kw">create_vm_scaleset</span>(<span class="st">&quot;slavess&quot;</span>, <span class="kw">user_config</span>(<span class="st">&quot;myname&quot;</span>, <span class="st">&quot;~/.ssh/id_rsa.pub&quot;</span>),</a>
<a class="sourceLine" id="cb9-14" title="14">                      <span class="dt">instances=</span><span class="dv">5</span>, <span class="dt">vnet=</span>vnet, <span class="dt">nsg=</span><span class="ot">NULL</span>)</a></code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
