<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Hong Ooi" />


<title>Introduction to AzureVM</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Introduction to AzureVM</h1>
<h4 class="author"><em>Hong Ooi</em></h4>



<p>This is a short introduction on how to use AzureVM.</p>
<div id="creating-a-vm" class="section level2">
<h2>Creating a VM</h2>
<p>Creating a VM is as simple as using the <code>create_vm</code> method, which is available as part of the <code>az_subscription</code> and <code>az_resource_group</code> classes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## using the subscription method
sub &lt;-<span class="st"> </span>az_rm$
<span class="st">    </span><span class="kw">new</span>(<span class="dt">tenant=</span><span class="st">&quot;{tenant_id}&quot;</span>, <span class="dt">app=</span><span class="st">&quot;{app_id}&quot;</span>, <span class="dt">password=</span><span class="st">&quot;{password}&quot;</span>)$
<span class="st">    </span><span class="kw">get_subscription</span>(<span class="st">&quot;{subscription_id}&quot;</span>)

myNewVM &lt;-<span class="st"> </span>sub$<span class="kw">create_vm</span>(<span class="st">&quot;myNewVM&quot;</span>,
    <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>,
    <span class="dt">username=</span><span class="st">&quot;datascience&quot;</span>,
    <span class="dt">passkey=</span><span class="st">&quot;fAs30q-2a5vF!Z&quot;</span>)  <span class="co"># be sure to choose a strong password!</span>


## using the resource group method
rg &lt;-<span class="st"> </span>sub$<span class="kw">create_resource_group</span>(<span class="st">&quot;myresourcegroup&quot;</span>,
    <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>)

myOtherVM &lt;-<span class="st"> </span>rg$<span class="kw">create_vm</span>(<span class="st">&quot;myOtherVM&quot;</span>,
    <span class="dt">username=</span><span class="st">&quot;datascience&quot;</span>,
    <span class="dt">passkey=</span><span class="st">&quot;l3Kgrf21%?0DFm&quot;</span>)</code></pre></div>
<p>Without any other options, this will create a Windows Server 2016 <a href="https://docs.microsoft.com/en-us/azure/machine-learning/data-science-virtual-machine/overview#whats-included-in-the-data-science-vm">Data Science Virtual Machine</a>, which is pre-installed with several tools useful for analytics: Python, R (and RStudio), Tensorflow, XGBoost, SQL Server, and so on. The size will be a Standard DS3 V2 VM, which has 4 cores, 14GB of memory, 1TB primary disk, and up to 16x28GB data disks.</p>
<p>A feature of using the <code>az_subscription</code> method is that it creates a new resource group specifically to hold the VM. This simplifies the task of managing and (eventually) deleting the VM considerably. See “Deleting a VM” below.</p>
<p>You can change the specifications for the VM by providing any of the following arguments:</p>
<ul>
<li><code>os</code>: either “Windows” or “Ubuntu” (for Ubuntu LTS 16.04).</li>
<li><code>size</code>: the VM size. Use the <code>az_subscription$list_vm_sizes()</code> method to see what sizes are available in your region. Note that in Azure, a VM’s size is really a broad-ranging label that encapsulates the number of cores, memory, and disk available.</li>
<li><code>passkey</code>: if creating an Ubuntu VM, you can supply a public key as the <code>passkey</code> argument.</li>
<li><code>userauth_type</code>: set this to “key” if you supply a public key.</li>
</ul>
<p>Setting these will determine whether you get a Windows or Ubuntu DSVM, the login details, and how powerful the VM is in terms of cores and memory/disk capacity.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># examine VM sizes available in australiaeast region</span>
sub$<span class="kw">list_vm_sizes</span>(<span class="st">&quot;australiaeast&quot;</span>)

<span class="co"># create a Linux (Ubuntu) NC-series DSVM using public key authentication</span>
myLinuxVM &lt;-<span class="st"> </span>sub$<span class="kw">create_vm</span>(<span class="st">&quot;myLinuxVM&quot;</span>,
    <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>,
    <span class="dt">size=</span><span class="st">&quot;Standard_NC6s_v3&quot;</span>,
    <span class="dt">os=</span><span class="st">&quot;Ubuntu&quot;</span>,
    <span class="dt">username=</span><span class="st">&quot;datascience&quot;</span>,
    <span class="dt">passkey=</span><span class="kw">readLines</span>(<span class="st">&quot;~/id_rsa.pub&quot;</span>),
    <span class="dt">userauth_type=</span><span class="st">&quot;key&quot;</span>)</code></pre></div>
</div>
<div id="retrieving-an-existing-vm" class="section level2">
<h2>Retrieving an existing VM</h2>
<p>If you have an existing VM, you can retrieve it with the <code>get_vm()</code> method. As with <code>create_vm()</code>, this is available as part of the <code>az_subscription</code> and <code>az_resource_group</code> classes. The only argument you need to supply is the name of the VM.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## using the subscription method
sub &lt;-<span class="st"> </span>az_rm$
<span class="st">    </span><span class="kw">new</span>(<span class="dt">tenant=</span><span class="st">&quot;{tenant_id}&quot;</span>, <span class="dt">app=</span><span class="st">&quot;{app_id}&quot;</span>, <span class="dt">password=</span><span class="st">&quot;{password}&quot;</span>)$
<span class="st">    </span><span class="kw">get_subscription</span>(<span class="st">&quot;{subscription_id}&quot;</span>)

<span class="co"># retrieve the VM we created above</span>
myNewVM &lt;-<span class="st"> </span>sub$<span class="kw">get_vm</span>(<span class="st">&quot;myNewVM&quot;</span>)


## and with the resource group method
rg &lt;-<span class="st"> </span>sub$<span class="kw">get_resource_group</span>(<span class="st">&quot;myresourcegroup&quot;</span>)

myOtherVM &lt;-<span class="st"> </span>rg$<span class="kw">get_vm</span>(<span class="st">&quot;myOtherVM&quot;</span>)</code></pre></div>
</div>
<div id="working-with-a-vm" class="section level2">
<h2>Working with a VM</h2>
<p>There are various things you can do with a VM object.</p>
<p>To stop (shutdown) a VM, call its <code>stop()</code> method. The <code>deallocate</code> argument sets whether to deallocate its resources as well, with the default being TRUE; you may want to set this to FALSE if you know you will be restarting the VM soon. To restart it, call either the <code>start()</code> or <code>restart()</code> method. The main difference between the two is that <code>restart()</code> will shutdown the VM first if it is currently running.</p>
<p>To sync the object with the resource in Azure, call the <code>sync_vm_status()</code> method. The most common situation where you might want to do this is if you create a VM with the argument <code>wait=FALSE</code>. In this case, rather than waiting for provisioning to complete, the <code>create_vm</code> method will return an incomplete VM object; you then call its <code>sync_vm_status()</code> method to update it with how the provisioning is going in Azure.</p>
<p>To run a script in the VM (without manually logging in first), call the <code>run_script()</code> method. This will be a PowerShell script if it is a Windows VM, or a bash script if it is Linux. The script is just a character vector:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># simple bash script for executing on a Linux VM</span>
script &lt;-
<span class="st">'#!/bin/bash</span>

<span class="st">var=Hello world!</span>

<span class="st"># redirect output to a file so we know whether it ran successfully</span>
<span class="st">echo &quot;$var&quot; &gt; /tmp/helloworld.txt</span>
<span class="st">'</span>

vm$<span class="kw">run_script</span>(script)</code></pre></div>
<p>If you login to the VM after running this script, you should find the file <code>helloworld.txt</code> in the <code>/tmp</code> directory.</p>
</div>
<div id="deleting-a-vm" class="section level2">
<h2>Deleting a VM</h2>
<p>Simply deleting a virtual machine object in R, eg with <code>rm()</code>, will not do anything to the VM itself in Azure. To delete the VM and its resources, call the object’s <code>delete()</code> method:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">vm$<span class="kw">delete</span>()</code></pre></div>
<p>AzureVM will prompt you for confirmation that you really want to delete the VM. By default, this will also free up all the individual Azure resources used by the VM, such as its storage, network interface, security group, and so on.</p>
<p>If you created the VM using the <code>create_vm()</code> method of the <code>az_subscription</code> class, the deletion process is very simple: it simply removes the resource group containing the VM. This is possible because the resource group was created as part of deploying the VM. Be aware that any other resources you may have created in this resource group will also be deleted.</p>
<p>Alternatively, you can use the <code>delete_vm()</code> method of the <code>az_subscription</code> and <code>az_resource_group</code> classes. These will retrieve the VM of the given name and then call its <code>delete()</code> method.</p>
</div>
<div id="other-topics" class="section level2">
<h2>Other topics</h2>
<div id="gpu-enabled-vms" class="section level3">
<h3>GPU enabled VMs</h3>
<p>If you are running deep learning workloads, you’ll want to ensure that your VM is GPU-enabled. In Azure, the various <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/windows/sizes-gpu">NC- and ND-series VMs</a> are designed for these workloads. You can create a GPU-enabled VM by setting the <code>size</code> argument appropriately, for example</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">myGpuVM &lt;-<span class="st"> </span>sub$<span class="kw">create_vm</span>(<span class="dt">size=</span><span class="st">&quot;Standard_NC12s_v3&quot;</span>, ...)</code></pre></div>
<p>However, the following caveats apply to GPU-enabled VMs: - Not all regions have GPUs available. To check on availability, use the <code>az_subscription$list_vm_sizes()</code> method and provide your region. - Currently, the supply of GPUs is limited. You must <a href="https://docs.microsoft.com/en-us/azure/azure-supportability/resource-manager-core-quotas-request">apply for a quota increase</a> if you want to deploy a GPU-enabled VM.</p>
</div>
<div id="vm-clusters" class="section level3">
<h3>VM clusters</h3>
<p>You can work with VM clusters (a collection of VMs sharing the same configuration) by using the <code>get_vm_cluster</code>, <code>create_vm_cluster</code> and <code>delete_vm_cluster</code> methods. These work almost identically to <code>get_vm</code>, <code>create_vm</code> and <code>delete_vm</code> with the addition of a <code>clust_size</code> argument that sets the size of the cluster.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sub &lt;-<span class="st"> </span>az_rm$
<span class="st">    </span><span class="kw">new</span>(<span class="dt">tenant=</span><span class="st">&quot;{tenant_id}&quot;</span>, <span class="dt">app=</span><span class="st">&quot;{app_id}&quot;</span>, <span class="dt">password=</span><span class="st">&quot;{password}&quot;</span>)$
<span class="st">    </span><span class="kw">get_subscription</span>(<span class="st">&quot;{subscription_id}&quot;</span>)

<span class="co"># create a cluster of 5 Ubuntu VMs</span>
vmCluster &lt;-<span class="st"> </span>sub$<span class="kw">create_vm_cluster</span>(<span class="st">&quot;vmCluster&quot;</span>,
    <span class="dt">location=</span><span class="st">&quot;australiaeast&quot;</span>,
    <span class="dt">os=</span><span class="st">&quot;Ubuntu&quot;</span>,
    <span class="dt">username=</span><span class="st">&quot;datascience&quot;</span>,
    <span class="dt">passkey=</span><span class="kw">readLines</span>(<span class="st">&quot;~/id_rsa.pub&quot;</span>),
    <span class="dt">userauth_type=</span><span class="st">&quot;key&quot;</span>,
    <span class="dt">clust_size=</span><span class="dv">5</span>)</code></pre></div>
<p>Most things that you can do with a single VM, you can also do with a VM cluster. For example, running a script with the <code>run_script()</code> method will run the script on all the VMs in the cluster. Starting, stopping and restarting a cluster similarly carries out the given action on all the VMs.</p>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
